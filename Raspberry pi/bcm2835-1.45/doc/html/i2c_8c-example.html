<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>bcm2835: i2c.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">bcm2835
   &#160;<span id="projectnumber">1.45</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Modules</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">i2c.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Command line utility for executing i2c commands with the Broadcom bcm2835. Contributed by Shahrooz Shahparnia.</p>
<div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*   i2c.c</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*   Copyright (c) 2013 Shahrooz Shahparnia (sshahrooz@gmail.com)</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*   Description:</span></div>
<div class="line"><span class="comment">*   i2c is a command-line utility for executing i2c commands with the </span></div>
<div class="line"><span class="comment">*   Broadcom bcm2835.  It was developed and tested on a Raspberry Pi single-board</span></div>
<div class="line"><span class="comment">*   computer model B.  The utility is based on the bcm2835 C library developed</span></div>
<div class="line"><span class="comment">*   by Mike McCauley of Open System Consultants, http://www.open.com.au/mikem/bcm2835/.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*   Invoking spincl results in a read or write I2C transfer.  Options include the</span></div>
<div class="line"><span class="comment">*   the I2C clock frequency, read/write, address, and port initialization/closing</span></div>
<div class="line"><span class="comment">*   procedures.  The command usage and command-line parameters are described below</span></div>
<div class="line"><span class="comment">*   in the showusage function, which prints the usage if no command-line parameters</span></div>
<div class="line"><span class="comment">*   are included or if there are any command-line parameter errors.  Invoking i2c </span></div>
<div class="line"><span class="comment">*   requires root privilege.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*   This file contains the main function as well as functions for displaying</span></div>
<div class="line"><span class="comment">*   usage and for parsing the command line.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*   Open Source Licensing GNU GPLv3</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*   Building:</span></div>
<div class="line"><span class="comment">* After installing bcm2835, you can build this </span></div>
<div class="line"><span class="comment">* with something like:</span></div>
<div class="line"><span class="comment">* gcc -o i2c i2c.c -l bcm2835</span></div>
<div class="line"><span class="comment">* sudo ./i2c</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* Or you can test it before installing with:</span></div>
<div class="line"><span class="comment">* gcc -o i2c -I ../../src ../../src/bcm2835.c i2c.c</span></div>
<div class="line"><span class="comment">* sudo ./i2c</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*   History:</span></div>
<div class="line"><span class="comment">*   11/05    VERSION 1.0.0: Original</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*      User input parsing (comparse) and showusage\</span></div>
<div class="line"><span class="comment">*      have been adapted from: http://ipsolutionscorp.com/raspberry-pi-spi-utility/</span></div>
<div class="line"><span class="comment">*      mostly to keep consistence with the spincl tool usage.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*      Compile with: gcc -o i2c i2c.c bcm2835.c</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*      Examples:</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*           Set up ADC (Arduino: ADC1015)</span></div>
<div class="line"><span class="comment">*           sudo ./i2c -s72 -dw -ib 3 0x01 0x44 0x00 (select config register, setup mux, etc.)</span></div>
<div class="line"><span class="comment">*           sudo ./i2c -s72 -dw -ib 1 0x00 (select ADC data register)</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*           Bias DAC (Arduino: MCP4725) at some voltage</span></div>
<div class="line"><span class="comment">*           sudo ./i2c -s99 -dw -ib 3 0x60 0x7F 0xF0 (FS output is with 0xFF 0xF0)</span></div>
<div class="line"><span class="comment">*           Read ADC convergence result</span></div>
<div class="line"><span class="comment">*           sudo ./i2c -s72 -dr -ib 2 (FS output is 0x7FF0 with PGA1 = 1)</span></div>
<div class="line"><span class="comment">*  </span></div>
<div class="line"><span class="comment">*      In a DAC to ADC loop back typical results are:</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*      DAC    VOUT   ADC</span></div>
<div class="line"><span class="comment">*      7FFh   1.6V   677h                    Note ratio is FS_ADC*PGA_GAIN/FS_DAC = 4.096/3.3 = 1.23</span></div>
<div class="line"><span class="comment">*      5FFh   1.2V   4DCh</span></div>
<div class="line"><span class="comment">*      8F0h   1.8V   745h</span></div>
<div class="line"><span class="comment">*      9D0h   2V     7EAh</span></div>
<div class="line"><span class="comment">*      000h   10mV   004h</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">********************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;bcm2835.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MODE_READ 0</span></div>
<div class="line"><span class="preprocessor">#define MODE_WRITE 1</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define MAX_LEN 32</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">char</span> wbuf[MAX_LEN];</div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    NO_ACTION,</div>
<div class="line">    I2C_BEGIN,</div>
<div class="line">    I2C_END</div>
<div class="line">} i2c_init;</div>
<div class="line"></div>
<div class="line">uint8_t  init = NO_ACTION;</div>
<div class="line">uint16_t clk_div = <a name="a0"></a><a class="code" href="group__constants.html#gga98a5303c1b527513fb659472601687bbac7f74bf858f71efb5f9b4ec5cb9cef7b">BCM2835_I2C_CLOCK_DIVIDER_148</a>;</div>
<div class="line">uint8_t slave_address = 0x00;</div>
<div class="line">uint32_t len = 0;</div>
<div class="line">uint8_t  mode = MODE_READ;</div>
<div class="line"></div>
<div class="line"><span class="comment">//*******************************************************************************</span></div>
<div class="line"><span class="comment">//  comparse: Parse the command line and return EXIT_SUCCESS or EXIT_FAILURE</span></div>
<div class="line"><span class="comment">//    argc: number of command-line arguments</span></div>
<div class="line"><span class="comment">//    argv: array of command-line argument strings</span></div>
<div class="line"><span class="comment">//*******************************************************************************</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> comparse(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {</div>
<div class="line">    <span class="keywordtype">int</span> argnum, i, xmitnum;</div>
<div class="line">        </div>
<div class="line">    <span class="keywordflow">if</span> (argc &lt; 2) {  <span class="comment">// must have at least program name and len arguments</span></div>
<div class="line">                     <span class="comment">// or -ie (I2C_END) or -ib (I2C_BEGIN)</span></div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Insufficient command line arguments\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    argnum = 1;</div>
<div class="line">    <span class="keywordflow">while</span> (argnum &lt; argc &amp;&amp; argv[argnum][0] == <span class="charliteral">&#39;-&#39;</span>) {</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">switch</span> (argv[argnum][1]) {</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:  <span class="comment">// I2C init</span></div>
<div class="line">                <span class="keywordflow">switch</span> (argv[argnum][2]) {</div>
<div class="line">                    <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>: init = I2C_BEGIN; <span class="keywordflow">break</span>;</div>
<div class="line">                    <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>: init = I2C_END; <span class="keywordflow">break</span>;</div>
<div class="line">                    <span class="keywordflow">default</span>:</div>
<div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%c is not a valid init option\n&quot;</span>, argv[argnum][2]);</div>
<div class="line">                        <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:  <span class="comment">// Read/Write Mode</span></div>
<div class="line">                <span class="keywordflow">switch</span> (argv[argnum][2]) {</div>
<div class="line">                    <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>: mode = MODE_READ; <span class="keywordflow">break</span>;</div>
<div class="line">                    <span class="keywordflow">case</span> <span class="charliteral">&#39;w&#39;</span>: mode = MODE_WRITE; <span class="keywordflow">break</span>;</div>
<div class="line">                    <span class="keywordflow">default</span>:</div>
<div class="line">                        fprintf(stderr, <span class="stringliteral">&quot;%c is not a valid init option\n&quot;</span>, argv[argnum][2]);</div>
<div class="line">                        <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:  <span class="comment">// Clock divider</span></div>
<div class="line">                clk_div = atoi(argv[argnum]+2);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:  <span class="comment">// Slave address</span></div>
<div class="line">                slave_address = atoi(argv[argnum]+2);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">default</span>:</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;%c is not a valid option\n&quot;</span>, argv[argnum][1]);</div>
<div class="line">                <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        argnum++;   <span class="comment">// advance the argument number</span></div>
<div class="line"></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// If command is used for I2C_END or I2C_BEGIN only</span></div>
<div class="line">    <span class="keywordflow">if</span> (argnum == argc &amp;&amp; init != NO_ACTION) <span class="comment">// no further arguments are needed</span></div>
<div class="line">        <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">        </div>
<div class="line">    <span class="comment">// Get len</span></div>
<div class="line">    <span class="keywordflow">if</span> (strspn(argv[argnum], <span class="stringliteral">&quot;0123456789&quot;</span>) != strlen(argv[argnum])) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Invalid number of bytes specified\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    len = atoi(argv[argnum]);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (len &gt; MAX_LEN) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Invalid number of bytes specified\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    argnum++;   <span class="comment">// advance the argument number</span></div>
<div class="line"></div>
<div class="line">    xmitnum = argc - argnum;    <span class="comment">// number of xmit bytes</span></div>
<div class="line"></div>
<div class="line">    memset(wbuf, 0, <span class="keyword">sizeof</span>(wbuf));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; xmitnum; i++) {</div>
<div class="line">        <span class="keywordflow">if</span> (strspn(argv[argnum + i], <span class="stringliteral">&quot;0123456789abcdefABCDEFxX&quot;</span>) != strlen(argv[argnum + i])) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;Invalid data: &quot;</span>);</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;%d \n&quot;</span>, xmitnum);</div>
<div class="line">            <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line">        }</div>
<div class="line">        wbuf[i] = (char)strtoul(argv[argnum + i], NULL, 0);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">//*******************************************************************************</span></div>
<div class="line"><span class="comment">//  showusage: Print the usage statement and return errcode.</span></div>
<div class="line"><span class="comment">//*******************************************************************************</span></div>
<div class="line"><span class="keywordtype">int</span> showusage(<span class="keywordtype">int</span> errcode) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;i2c \n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;Usage: \n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;  i2c [options] len [rcv/xmit bytes]\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;  Invoking i2c results in an I2C transfer of a specified\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;    number of bytes.  Additionally, it can be used to set the appropriate\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;    GPIO pins to their respective I2C configurations or return them\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;    to GPIO input configuration.  Options include the I2C clock frequency,\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;    initialization option (i2c_begin and i2c_end).  i2c must be invoked\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;    with root privileges.\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;  The following are the options, which must be a single letter\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;    preceded by a &#39;-&#39; and followed by another character.\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;    -dx where x is &#39;w&#39; for write and &#39;r&#39; is for read.\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;    -ix where x is the I2C init option, b[egin] or e[nd]\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;      The begin option must be executed before any transfer can happen.\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;        It may be included with a transfer.\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;      The end option will return the I2C pins to GPIO inputs.\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;        It may be included with a transfer.\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;    -cx where x is the clock divider from 250MHz. Allowed values\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;      are 150 through 2500.\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;      Corresponding frequencies are specified in bcm2835.h.\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;    len: The number of bytes to be transmitted or received.\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;    The maximum number of bytes allowed is %d\n&quot;</span>, MAX_LEN);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> errcode;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">char</span> buf[MAX_LEN];</div>
<div class="line"><span class="keywordtype">int</span> i;</div>
<div class="line">uint8_t data;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {</div>
<div class="line"></div>
<div class="line">    printf(<span class="stringliteral">&quot;Running ... \n&quot;</span>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// parse the command line</span></div>
<div class="line">    <span class="keywordflow">if</span> (comparse(argc, argv) == EXIT_FAILURE) <span class="keywordflow">return</span> showusage (EXIT_FAILURE);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!<a name="a1"></a><a class="code" href="group__init.html#ga9351fa3ec8eeff4e9d998d3d5d912a4f">bcm2835_init</a>()) <span class="keywordflow">return</span> 1;</div>
<div class="line">      </div>
<div class="line">    <span class="comment">// I2C begin if specified    </span></div>
<div class="line">    <span class="keywordflow">if</span> (init == I2C_BEGIN) <a name="a2"></a><a class="code" href="group__i2c.html#ga1309569f7363853333f3040b1553ea64">bcm2835_i2c_begin</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// If len is 0, no need to continue, but do I2C end if specified</span></div>
<div class="line">    <span class="keywordflow">if</span> (len == 0) {</div>
<div class="line">         <span class="keywordflow">if</span> (init == I2C_END) <a name="a3"></a><a class="code" href="group__i2c.html#ga0a91c4c5cdfe6d7d8fc127b4f3122db4">bcm2835_i2c_end</a>();</div>
<div class="line">         printf(<span class="stringliteral">&quot;... done!\n&quot;</span>);</div>
<div class="line">         <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a name="a4"></a><a class="code" href="group__i2c.html#ga6b0495cb138bd5eb26965f5a00b08dc0">bcm2835_i2c_setSlaveAddress</a>(slave_address);</div>
<div class="line">    <a name="a5"></a><a class="code" href="group__i2c.html#ga6a00e88236977643f0727557cfa16838">bcm2835_i2c_setClockDivider</a>(clk_div);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;Clock divider set to: %d\n&quot;</span>, clk_div);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;len set to: %d\n&quot;</span>, len);</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;Slave address set to: %d\n&quot;</span>, slave_address);   </div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (mode == MODE_READ) {</div>
<div class="line">        <span class="keywordflow">for</span> (i=0; i&lt;MAX_LEN; i++) buf[i] = <span class="charliteral">&#39;n&#39;</span>;</div>
<div class="line">        data = <a name="a6"></a><a class="code" href="group__i2c.html#ga5d01c1483ae12ff682068d0a56b6529a">bcm2835_i2c_read</a>(buf, len);</div>
<div class="line">        printf(<span class="stringliteral">&quot;Read Result = %d\n&quot;</span>, data);   </div>
<div class="line">        <span class="keywordflow">for</span> (i=0; i&lt;MAX_LEN; i++) {</div>
<div class="line">                <span class="keywordflow">if</span>(buf[i] != <span class="charliteral">&#39;n&#39;</span>) printf(<span class="stringliteral">&quot;Read Buf[%d] = %x\n&quot;</span>, i, buf[i]);</div>
<div class="line">        }    </div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (mode == MODE_WRITE) {</div>
<div class="line">        data = <a name="a7"></a><a class="code" href="group__i2c.html#ga8e9d3835ace8697fd9e7bf1278b3ba76">bcm2835_i2c_write</a>(wbuf, len);</div>
<div class="line">        printf(<span class="stringliteral">&quot;Write Result = %d\n&quot;</span>, data);</div>
<div class="line">    }   </div>
<div class="line"></div>
<div class="line">    <span class="comment">// This I2C end is done after a transfer if specified</span></div>
<div class="line">    <span class="keywordflow">if</span> (init == I2C_END) <a class="code" href="group__i2c.html#ga0a91c4c5cdfe6d7d8fc127b4f3122db4">bcm2835_i2c_end</a>();   </div>
<div class="line">    <a name="a8"></a><a class="code" href="group__init.html#ga3a42892f61764132d106a4ae32271002">bcm2835_close</a>();</div>
<div class="line">    printf(<span class="stringliteral">&quot;... done!\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
